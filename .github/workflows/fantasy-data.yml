name: Extract Fantasy Data to JSON

on:
  # Schedule: Runs at key decision points throughout the fantasy week
  schedule:
    # TUESDAY - Injury reports after Monday night (9:00 AM ET = 1:00 PM UTC)
    - cron: '0 13 * * 2'
    
    # WEDNESDAY - Waiver claims processing (runs 3 times to catch roster changes)
    - cron: '0 11 * * 3'  # 7:00 AM ET - Early claims
    - cron: '0 14 * * 3'  # 10:00 AM ET - Mid-morning claims
    - cron: '0 18 * * 3'  # 2:00 PM ET - Afternoon claims
    
    # THURSDAY - Pre-game update (3:00 PM ET = 7:00 PM UTC, before TNF at 8:15 PM ET)
    - cron: '0 19 * * 4'
    
    # SATURDAY - Post-practice injury reports (7:00 PM ET = 11:00 PM UTC)
    - cron: '0 23 * * 6'
    
    # SUNDAY - Pre-games update (11:00 AM ET = 3:00 PM UTC, before 1 PM games)
    - cron: '0 15 * * 0'
    
    # MONDAY - Pre-MNF update (6:00 PM ET = 10:00 PM UTC, before 8:15 PM games)
    - cron: '0 22 * * 1'
  
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run (optional)'
        required: false
        default: 'Manual data refresh'

jobs:
  extract:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install espn-api requests numpy
      
      - name: Extract ESPN Data
        env:
          ESPN_S2: ${{ secrets.ESPN_S2 }}
          SWID: ${{ secrets.SWID }}
        run: |
          python extract_espn_data_json.py
          echo "=== Files created after extraction ==="
          ls -lah *.json 2>/dev/null || echo "No JSON files found"
      
      - name: Analyze Players
        run: |
          if [ -f "fantasy-data.json" ]; then
            python player_scoring.py fantasy-data.json
          else
            echo "ERROR: fantasy-data.json not found!"
            echo "Available files:"
            ls -la
            exit 1
          fi
      
      - name: Verify Output Files
        run: |
          echo "=== Final output files ==="
          ls -lah *.json
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
